<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Flownet</title>

      <script src="lib/three.min.js"></script>
      <script src="lib/jquery.min.js"></script>
      <script src="lib/d3.min.js"></script>
      <script src="lib/cola.min.js"></script>
      <script src="lib/topojson.v1.min.js"></script>
      <script src="Sparkiz.js"></script>
      <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

      <style>

   	.node circle {
   	  fill: none;
   	  stroke: steelblue;
   	  stroke-width: 3px;
   	}

   	.node text { font: 12px sans-serif; }

   	.link {
   	  fill: none;
   	  stroke: white;
   	  stroke-width: 2px;
   	}
    body{
      margin:0;
      font-family: "Roboto", "Myriad Pro";
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    #legend{
      position: absolute;
      top: 10%;
      width: 30%;
      /* text-align: center; */
      font-style: italic;
      font-size: 15px;
      right: 10%;
      background-color: rgba(163, 163, 163, 0.5);
      padding: 15px;
    }

       </style>
     </head>
     <body>
     <div class="bandeau-top" style="width:100%; height:20px; background-color:black; color:white; text-align: center; padding:7px;">
     Optimized for Chrome
     </div>
     <div id="legend">
            A simple propagation example
          </div>
       <div id="visFrame"></div>
          
   <script>
   var width = 2000,
       height = 1000;

     var tube_size = d3.scale.linear()
                   .domain([0, 60])
                   .range([1,10])

                   var scale_frequency_pattern = d3.scale.linear()
                             .domain([0, 60])
                             .range([0.2, 1.8])
                  

   var orientations = {
     "top-to-bottom": {
       size: [width/2, height/2],
       x: function(d) { return d.x; },
       y: function(d) { return d.y + 80; }
     }
   };

   var svg = d3.select("body").selectAll("svg")
       .data(d3.entries(orientations))
     .enter().append("svg")
       .attr("width", width)
       .attr("height", height)

  //  svg.append("rect")
  //      .attr("width", width)
  //      .attr("height", height)
  //      .attr("class", "border");

  //  svg.append("text")
  //      .attr("x", 6)
  //      .attr("y", 6)
  //      .attr("dy", ".71em")
  //      .text(function(d) { return d.key; });

d3.json("graph.json", function(error, root) {
    var links;
    var nodes;
    var tree;

     if (error) throw error;

  svg.each(function(orientation) {
       var svg = d3.select(this),
           o = orientation.value;

       // Compute the layout.
       tree = d3.layout.tree().size(o.size),
           nodes = tree.nodes(root),
           links = tree.links(nodes);

           console.log()
       // Create the link lines.
       svg.selectAll(".link")
           .data(links)
         .enter().append("path")
           .attr("class", "link")
           .attr("d", d3.svg.diagonal().projection(function(d) { return [o.x(d), o.y(d)]; }));

       // Create the node circles.
       // svg.selectAll(".node")
       //     .data(nodes)
       //   .enter().append("circle")
       //     .attr("class", "node")
       //     .attr("r", function(d, i) { return 4.5; })
       //     .attr("cx", o.x)
       //     .attr("cy", o.y)
     });

     nodes.forEach(function(element) {
       var obj = element;
       element.Tx = element.x;
       element.Ty = element.y;
       //element.children = 0;
     });
     //var values = [10, 25, 3, 5, 10, 2, 32, 5, 6, 35, 2, 1, 25, 23, 24, 32, 5, 2, 26, 13, 12];
     links.forEach(function(element, i) {
      element.number_tweet = element.target.tweet_number;
      //element.number_tweet = values[i];
       // var parent = element.source.parent;
       // if (parent == undefined) element.source.number_tweet = 100;
       // console.log(parent)

       // var child_source = element.source.children.length;
       // element.source.number_tweet = 100;
      //  if (parent != undefined) {
      //     var number_compatriotes = parent.children.length;
      //     console.log(parent.number_tweet)
      //     element.number_tweet = parent.number_tweet/number_compatriotes;
      //  }
      // console.log(links)
       
       
     });
     console.log(links)
     console.log(nodes)
     launch_sparkiz(nodes, links);
});

function launch_sparkiz(nodes, links)
{

  console.log(nodes)
    var app = flownet.force("#visFrame", width ,height,"#abd9e9", 0)
              .nodes(nodes)
              .links(links)
              .layout("linkDistance", 200)
              .create_layout()
              .tracks("count", 1 )
              
              .create_WEBGL_element()
              .zoom(true)
              //.controls(true)
              .link_properties("curvature", 50000)
              .link_properties("size", 3)//function(d, i) {return tube_size(d.number_tweet); })
              .link_properties("opacity", 0.4)
              .node_properties("color", "#fdae61")

              .node_properties("size",  10)
              .node_properties("x", function(d, i) {return d.Tx - (width/2); })
              .node_properties("y", function(d, i) {return -d.Ty + (height/2) - 80; })
              //.nodes_mapping("label", function(d, i) {return d.name; })
              .particles("frequency", function(d, i) {return scale_frequency_pattern(d.number_tweet); })
              .particles("color", "#1f253d")
              .particles("size", 5)//function(d, i) {return d.number_tweet * 1.5; })
              .particles("texture", "rectangle.png")

              
              .particles("pattern",  [0.0])
              .particles("speed", 1)

              .start_particle_delay(20000)
              .start(0)



    // var app = Sparkiz.force("#visFrame", 1800 ,900, "grey",0)
    //       .nodes(json.nodes)
    //       .links(json.links)
    //       .layout("linkDistance", 200)
    //       .create_layout()

    //       .roads_mapping("number_roads", 1 )
    //       .links_mapping("courbure", 10000)
    //       .create_WEBGL_element()
    //       //.zoom(true)
    //       .controls(true)
    //       .links_mapping("color", "#b5b5b5")
    //       .links_mapping("size", 3)
    //       //
    //       .nodes_mapping("color", "black")
    //       .nodes_mapping("size", 5)
}





  </script>


</body>
</html>
