<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Aerial Traffic</title>

      <script src="lib/three.min.js"></script>
      <script src="lib/d3.v3.min.js"></script>
      <script src="lib/cola.min.js"></script>
      <script src="lib/topojson.v1.min.js"></script>
      <script src="lib/jquery.min.js"></script>
      <script src="lib/d3.geo.projection.v0.min.js"></script>

       <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

       <link rel='stylesheet' href='lib/slider.css'>
       <link rel='stylesheet' href='lib/loader.css'>
       <link rel='stylesheet' href='lib/font-awesome.min.css'>
      <script src="lib/Sparkiz.js"></script>
    <style>
        body{
          margin:0;
          font-family: 'Roboto', "Times", "Arial"
        }

        canvas {
          position: absolute;
          top: 0;
          left: 0;
        }
        .land {
          fill: #abdda4;
          stroke: black;
        }
        .county-boundary {
          fill: none;
          stroke: none;
          stroke-width: .5px;
        }


        .state-boundary {
          fill: none;
          stroke: black;
        }
        #header_page{
          text-align: center;
          position: relative;
        }
        #header_page_h1{
          text-transform: uppercase;
          margin-bottom: 0px;
          font-size: 40px;
          text-align: center;
        }
        #header_page + span {
          font-size: 17px;
          text-transform: lowercase;
        }




        #legend{
          font-size: 30px;
          font-weight: normal;
          margin-bottom: 20px;

        }
        #legend:hover div {
          transition: all 0.5s ease;
          color:white;
          cursor: pointer;
        }
        #datas{
          position: absolute;
          bottom:50%;
          left:2%;
        }
        #menu {
          display: none;
          margin-top: 20px;
          max-width: 500px;

        }
        
        #menu div{
          margin-bottom: 5px;
        }
        .label_menu{
          font-size: 25px;
          letter-spacing: -1px;
          margin-top: 10px;
        }
        .box{
          background-color: rgba(0,0,0, 0.2);
          border-radius: 5px;
          padding:10px;
          display: inline;
        }
        #details {         
          position: absolute;
          bottom:10%;
          left:2%;
        }
        .text-button{
          display: inline;
        }
        .number{
          font-size: 30px;
          letter-spacing: -2px;
        }
        #loader{
          display: none;
        }
        #slider{
          position: absolute;
          bottom: 10%;
          left: 50%;
          font-size: 28px;
          letter-spacing: -1px;
        }
        .nav{
          
          margin: 10px;
        }
        .nav:hover{
          cursor: pointer;
          color:white;
        }
        .icon {
          color: black;
        }
        .icon:hover{
          color: white;
          font-size: 32px;
          cursor: pointer;
        }
        #legend{
          position: absolute;
          top: 10%;
          width: 30%;
          /* text-align: center; */
          font-style: italic;
          font-size: 15px;
          right: 1%;
          background-color: rgba(163, 163, 163, 0.7);
          padding: 15px;
        }
    </style>


</head>
<body>



  <div id="loader" class="loader">
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
    <span class="loader-block"></span>
  </div>
  
  <div id="visFrame"></div>
  <div id="header_page">
    <h2 id="header_page_h1">US Aerial Traffic</h2>
  </div>
  <div id="legend">
Statistics about flights in the United States (<a href="https://www.transtats.bts.gov">dataset</a>). Particles flow from one city to another. Their size and frequency respectively encode the average number of passengers and the average number of planes between these cities. Additionally, when there is an average departure delay on a flight route, particles are slowed down at the beginning of this route. This effect is achieved by emitting low-speed particles that are later accelerated with a transformation gate.
</div>
<div class="bandeau-top" style="position:absolute; top:0%;width:100%; height:20px; background-color:black; color:white; text-align: center; padding:7px;">
     Optimized for Chrome
     </div>

  <!-- <div id="details">
    <div class="box" id="legend">
      <div id="show-menu" class="text-button" title="show menu" lang="en">Flow Network <span id="menu-ham" aria-hidden="true">≡</span></div>
    </div>

    <div class="box" id="menu">
      
      <div>
        <div class="label_menu">Concept</div> 
        <div>We used particles to map multiple attributes on links. </div>
        <div>They are used as a texture and not as a single element. </div>
        <div>Each attributes of the particle represent a parameter of the link. </div>
      </div>
      <div>
        <div class="label_menu">Mapping</div>
        <div> Number of passengers mapped with Size </div>
        <div> Number of Plane mapped with Frequency </div>
        <div> Velocity at beginning mapped with Departure Delay </div>
      </div>
      <div>
        <div class="label_menu"> About</div>
        
        <div><a href="https://github.com/HugoRomat/Sparkiz"><i class="icon fa fa-github fa-2x" aria-hidden="true"></i></a>
             <a href="https://github.com/HugoRomat/Sparkiz"><i class="icon fa fa-globe fa-2x" aria-hidden="true"></i></a>
        </div>
      </div>
    </div>
  </div> -->

  <div id="datas">
    <div>From <span class="number" id="country"></span></div>
    <div><span class="number" id="total_plane"></span> planes</div>
    <div><span class="number" id="total_passenger"></span> passenger carried</div>
    <div><span class="number" id="total_carrier"></span> companies</div>

  </div>

  <div id="slider">
    <span class="nav" id="nav_backward">  «  </span>
    <span id="text_label_year">
      3
    </span> - 02 - 2008  - AM
    <span class="nav" id="nav_forward">  »  </span>
 </div>

  <script>

$("#loader").hide();
// EXPAND THE MENU 
$('#show-menu').click(function() {
  console.log("HEYY")
  if($('#menu').css('display') == 'none'){ 
    $("#menu").show( "slow" );
  } else { 
    $("#menu").hide( "slow" );
  }
  
});






  	var color_scale = d3.scale.linear()
                   .domain([0,400])
                   .range([d3.rgb("#ff0000"), d3.rgb('#fffe00')])
   	var size_scale = d3.scale.linear()
                    .domain([0,5000])
                    .range([5, 10])
    var speed_scale = d3.scale.linear()
                    .domain([0,20])
                    .range([1,8])

    var frequency_scale = d3.scale.linear()
                    .domain([0,5])
                    .range([0.1,2])

     var dep_delay_scale = d3.scale.linear()
                    .domain([0,100])
                    .range([1, 5])

    var proj = d3.geo.miller()
                    .scale(1300)
                    .center([-80,28])
                    .translate([-50,-10]);

var total_passengers = 0;
var total_plane = 0;
var total_carrier = 0;

var isoStates_to_Name;
var nameStates_to_iso;

var airports_data;

var actual_data;
var app;
var year_selected = 2008;
var day_selected = 3;
var country_selected = "WY";
$("#country" ).text("Wyoming");

d3.json("states_hash.json", function(states) {

  // FAIT DES DICTIONNAIRES AVEC LES ETATS
  isoStates_to_Name = states;
  nameStates_to_iso = array_flip(states);

  d3.json("airports.json", function(cities) {
  airports_data = []
  //console.log(cities.nodes)
  for (var i =0; i< cities.nodes.length; i++){
    var d = cities.nodes[i];
    airports_data[d.iata] = d;
  }

    d3.json("2008_01_3_AM.json", function(json) {
        actual_data = json;
        
        update(day_selected, year_selected,country_selected, actual_data);
      });
  });
});

/********** FUNCTION QUI PERMET D'UPDATER ***********/
function update(day_selected, year_selected, country_selected, dataset){

  $("#loader").show();

  var DATA = [];
  DATA["links"] = [];
  DATA["nodes"] = [];
  var i = 0
  var airports = [];
  var id_nodes = 0;

  total_passengers = 0;
  total_plane = 0;
  total_carrier = 0;
  $("#total_plane" ).text(total_plane);
  $("#total_passenger" ).text(total_passengers);
  $("#total_carrier" ).text(total_carrier);
  

  for (var i =0; i< dataset.links.length; i++){
    var d = dataset.links[i];
 
    // SI L'AEROPORT CORRESPOND EST DANS L'ETAT VOULU
    if (airports_data[d.origin].state == country_selected){
  
      if (airports[d.dest] == undefined) {
        airports[d.dest] = id_nodes; 
        id_nodes+=1; 
      }
      if (airports[d.origin] == undefined) {
        airports[d.origin] = id_nodes; 
        id_nodes+=1; 
      }
      d.source = airports[d.origin];
      d.target = airports[d.dest];
      DATA["links"].push(d);

    }
  }
  // CREE UN TABLEAU DE LA TAILLE VOULUE
  DATA["nodes"] = Array.apply(null, Array(airports.length)).map(Number.prototype.valueOf,0);

  //console.log(airports)
  // REMPLI LE TABLEAU AU CASE SELECTIONNE AUPARAVANT
  for (key in airports){
    DATA["nodes"][airports[key]] = airports_data[key]
  }
  // DELETE EVERYTHING
  for( var i = app.sparkiz.scene.children.length - 1; i >= 0; i--) {
    obj = app.sparkiz.scene.children[i];
    if (obj.name == "links") app.sparkiz.scene.remove(obj);
    if (obj.name == "roads") app.sparkiz.scene.remove(obj);
    if (obj.name.slice(0, 4) ==  "tube") app.sparkiz.scene.remove(obj);
    if (obj.name.slice(0, 15) == "particle_system") app.sparkiz.scene.remove(obj);
    if (obj.name == "circle") app.sparkiz.scene.remove(obj);
    if (obj.name == "label") app.sparkiz.scene.remove(obj);
  }
  app.sparkiz.links = []
  app.sparkiz.tube = []

  app.nodes(DATA["nodes"])
       .links(DATA["links"])

       .create_layout()
       .roads_mapping("number_roads", 1 )
       .links_mapping("courbure", 5)
       .create_WEBGL_element()

       .links_mapping("color", "#e0e0e0")
       .links_mapping("size", 5)
       .links_mapping("opacity", 0.2)

       .nodes_mapping("color", "black")
       .nodes_mapping("label", function(d, i) {return d.city; })
       .nodes_mapping("label_color", "#4d4d4d")
       
       .nodes_mapping("size", 1)
       .nodes_mapping("x", function(d, i) {return proj([d.long,d.lat])[0]; })
       .nodes_mapping("y", function(d, i) {return - proj([d.long,d.lat])[1];  })

       .particle_mapping("color", "#b2182b")
       .particle_mapping("size",function(d, i) {
          total_passengers += d.passengers ;
          $("#total_passenger" ).text(total_passengers);
          return size_scale(d.passengers); 
      })
       .particle_mapping("texture", "rectangle.png")

       .particle_mapping("frequency_pattern",function(d, i) {
        total_plane += d.number_plane ;
        $("#total_plane" ).text(total_plane);
        return frequency_scale(d.number_plane); 
      })
       .particle_mapping("temporal_distribution", [0])
       // .particle_mapping("temporal_distribution",function(d, i) {
       //    var value = 1.0/d.number_carrier; 
       //    var array = [];
       //    var val = 0;

       //    for (var i =0; i< d.number_carrier; i++){

       //      array.push(val)
       //      val += value;
       //    }
       //    //console.log(array)
       //    return array; 
       //  })
       //.particle_mapping("velocity",function(d, i) {return speed_scale(d.number_plane); })
      .particle_mapping("velocity",function(d, i) {
        total_carrier += d.number_carrier;
        $("#total_carrier" ).text(total_carrier);
        return speed_scale(d.number_carrier); 
      })



       // .particle_mapping("velocity_0",function(d, i) {var value = dep_delay_scale(d.dep_delay); if (value < 1){return 1;} return value })
       // .particle_mapping("velocity_1",function(d, i) {var value = dep_delay_scale(d.dep_delay); if (value < 1){return 1;} return value })
       // .particle_mapping("velocity_2",function(d, i) {var value = dep_delay_scale(d.dep_delay); if (value < 1){return 1;} return value })
       // .particle_mapping("velocity_3",function(d, i) {var value = dep_delay_scale(d.dep_delay); if (value < 1){return 1;} return value })

       .stop()
       .on("end", function() { $("#loader").hide(); })
       .start_particle_delay(200000000)
       .start(0);

       //


       
}

// POUR LE PREMIER PASSAGE
app = Sparkiz.force("#visFrame", 1800,1200,"#abd9e9", 0)
 .nodes([{
    "name": "SWE",
    "lat": "62",
    "lon": "15"
  }, {
    "name": "NOR",
    "lat": "62",
    "lon": "10"
  }])
 .links([{"id":0, "source": 0, "target":1}])
 .layout("linkDistance", 300)
 .create_layout()
 .zoom(true)
 //.controls(true)
 .roads_mapping("number_roads", 1 )
 .links_mapping("courbure", 5)
 .create_WEBGL_element()
 .particle_mapping("texture", "rectangle.png")

 .start_particle_delay(200000000)

 .start(0);


 app.sparkiz.draw_map(proj, 'data/us-states.json');
 app.viz._UI.callback = function(f){
    console.log("J'ai cliqué sur ", f);
    var name_country_selected = f.name;
    $("#country" ).text(name_country_selected);

    country_selected = nameStates_to_iso[name_country_selected];
    console.log("SELECTED", country_selected);
    update(day_selected, year_selected,country_selected,actual_data);
 }

// PERMET DE FLIPPER L'ARRAY
function array_flip( trans )
{
    var key, tmp_ar = {};
    for ( key in trans ){
        if ( trans.hasOwnProperty( key ) ){
            tmp_ar[trans[key]] = key;
        }
    }
    return tmp_ar;
}

 // SLIDER //
// $('#slider_day').change(function() {
//   var day_dataset = $(this).val();
//   day_selected = day_dataset;
//   d3.json("2008_01_"+ day_selected +"_AM.json", function(json) {
//     actual_data = json;
//     update(day_selected, year_selected, country_selected,actual_data);
//   });
  
//   //console.log(yo)
// });
// $('#nav_backward').on('input', function () {
//   var year_label = $(this).val();
//   $( "#text_label_year" ).text(year_label);
// });

$('#nav_forward').on('click', function () {
  day_selected += 1;
  $( "#text_label_year" ).text(day_selected);
  d3.json("2008_01_"+ day_selected +"_AM.json", function(json) {
    actual_data = json;
    update(day_selected, year_selected, country_selected,actual_data);
  });
});
$('#nav_backward').on('click', function () {
  day_selected -= 1;
  $( "#text_label_year" ).text(day_selected);

  d3.json("2008_01_"+ day_selected +"_AM.json", function(json) {
    actual_data = json;
    update(day_selected, year_selected, country_selected,actual_data);
  });
});



  </script>


</body>
</html>
