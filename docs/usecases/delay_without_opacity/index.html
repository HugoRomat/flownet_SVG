<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Flownet</title>

      <script src="lib/three.min.js"></script>
      <script src="lib/d3.min.js"></script>
      <script src="lib/cola.min.js"></script>
      <script src="lib/topojson.v1.min.js"></script>
      <script src="lib/jquery.min.js"></script>
      <script src="Sparkiz.js"></script>
      <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <style>
    body{
      margin:0;
      font-family: 'Roboto', "Times", "Arial";
    }

        canvas {
          position: absolute;
          top: 0;
          left: 0;
        }
        .land {
          /*fill: #abdda4;*/
          fill:#e3e3e3;
          opacity: 0.2;
          stroke: black;
        }

        .county-boundary {
          fill: none;
          stroke: none;
          opacity: 0.2;
          stroke-width: .5px;
        }

        .state-boundary {
          fill: none;
          opacity: 0.2;
          stroke: black;

        }
        #legend{
          position: absolute;
          top: 10%;
          width: 50%;
          /* text-align: center; */
          font-style: italic;
          font-size: 15px;
          margin-left: 10%;
          background-color: rgba(163, 163, 163, 0.5);
            padding: 15px;
        }

    </style>


</head>
<body>


  <div id="visFrame"></div>
    <div class="bandeau-top" style="position:absolute; top:0%;width:100%; height:20px; background-color:black; color:white; text-align: center; padding:7px;">
     Optimized for Chrome
     </div>
    <div id="legend">
    Gates are placed at 20% and 80% of the link's length. The speed of particles is altered when passing through those gates to visually encode departure and arrival delay, if any.
  </div>



  <script>
  var width = 1500;
  var height = 1500;
  var scale = 1800;

  var numLinks = 50;



  var color_scale = d3.scale.quantize()
                        .domain([1,3])
                        .range(["blue", "red", "green"]);

  var speed_scale = d3.scale.linear()
                 .domain([10, 100])
                 .range([1.5, 1]);


  var size_scale = d3.scale.linear()
                  .domain([0,10])
                  .range([1, 13])

  // var fin = 3;
  // var temporal = [[0, 0.1],[0.2, 0.3, 0.4], [0.5 , 0.6, 0.7, 0.8]];
  // var array_temporal = []


  // var chunks = chunkArray(temporal, fin)
  // for( var i = 0; i < chunks.length ; i++) {
  //   array_temporal.push(chunks[i][0])
  // }
  // console.log(array_temporal)
  // var speed_scale = d3.scale.linear()
  //                 .domain([0,100])
  //                 .range(array_speed)

  // var temporal_scale = d3.scale.quantize()
  //                       .domain([1,3])
  //                       .range(array_temporal);




  var proj = d3.geo.albersUsa()
                 .scale(scale)
                 .translate([0,0]);


  var projection = d3.geo.albersUsa()
                   .scale(scale)
                   .translate([width/2, height/2]);

  var path = d3.geo.path()
        .projection(projection);

var svg = d3.select("#visFrame").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("position", "absolute")
    .attr("top", "0")
    .attr("left", "0");

  d3.json("us.json", function(error, us) {
    if (error) throw error;

    svg.insert("path", ".graticule")
        .datum(topojson.feature(us, us.objects.land))
        .attr("class", "land")
        .attr("d", path);

    svg.insert("path", ".graticule")
        .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && !(a.id / 1000 ^ b.id / 1000); }))
        .attr("class", "county-boundary")
        .attr("d", path);

    svg.insert("path", ".graticule")
        .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .attr("class", "state-boundary")
        .attr("d", path);
});

var app;

function update(){

  d3.json("data 2.json", function(json) {


  app = flownet.force("#visFrame", width , height, "grey",0)
          .nodes(json.nodes)
          .links(json.links)
          .layout("linkDistance", 200)
          .create_layout()

          .tracks("count", 1 )

          .create_WEBGL_element()
          //.zoom(true)
          // .controls(true)

          .link_properties("curvature", 5000)
          .link_properties("color", "#b5b5b5")
          .link_properties("size", 4)
          .link_properties("opacity", 0)
          .node_properties("color", "#fdae61")
          .node_properties("size", 5)
       .node_properties("label", function(d, i) {return d.city; })
       .node_properties("label_x", 20)
       .node_properties("label_y", -5)
       .node_properties("label_color", "#000000")
       .node_properties("label_size", "12")
       .node_properties("size",  5)
       .node_properties("x", function(d, i) {return proj([d.long,d.lat])[0]; })
       .node_properties("y", function(d, i) {return - proj([d.long,d.lat])[1];  })

       .particles("color", "#4575b4")
       .particles("size", 10)

       .particles("speed", 1)
      .particles("texture", "images/rectangle_texture.png")
        .particles("speed", function(d, i) {return speed_scale(d.dep_delay); }, 0)


        .particles("speed", 2.4, 0.2)
       // .particles("opacity", 0.3, 0.1)
       // .particles("opacity", 1, 0.75)

       //.particles("size", 13)

        //.particles("pattern",  function(d, i) {return d.temp; })
        //.particles("pattern", [0.0])
        //.on("end", function() { alert("PROUT"); })



        .particles("speed", function(d, i) {return speed_scale(d.arr_delay); }, 0.75)


        .particles("pattern", [0])

        //.particles("track", [0])
        .particles("frequency", 1.3)

       .start_particle_delay(200000)
        .start(0)


      });





}
update();
$('#update').on('click', function () {
      clear_scene();
      update();
    });
$('#slider_size').on('input', function () {
      var size = $(this).val();
      $( "#label_slider_size" ).html(size);
      fin = size
      array_speed = []
    var chunks = chunkArray(speed, fin)
    for( var i = 0; i < chunks.length ; i++) {
      array_speed.push(chunks[i][0])
      }
      speed_scale = d3.scale.ordinal()
            .domain([0,100])
            .range(array_speed)
      console.log(array_speed)
    });

function clear_scene(){

  for( var i = app.sparkiz.scene.children.length - 1; i >= 0; i--) {
    obj = app.sparkiz.scene.children[i];
    if (obj.name == "links") app.sparkiz.scene.remove(obj);
    if (obj.name == "roads") app.sparkiz.scene.remove(obj);
    if (obj.name.slice(0, 4) ==  "tube") app.sparkiz.scene.remove(obj);
    if (obj.name.slice(0, 15) == "particle_system") app.sparkiz.scene.remove(obj);
    if (obj.name == "circle") app.sparkiz.scene.remove(obj);
    if (obj.name == "label") app.sparkiz.scene.remove(obj);
  }
  app.sparkiz.links = []
  app.sparkiz.tube = []
}

function chunkArray(arr, chunkCount) {
  const chunks = [];
  while(arr.length) {
    const chunkSize = Math.ceil(arr.length / chunkCount--);
    const chunk = arr.slice(0, chunkSize);
    chunks.push(chunk);
    arr = arr.slice(chunkSize);
  }
  return chunks;
}
function randomChoose (s, k) { // returns a random k element subset of s
  var a = [], i = -1, j;
  while (++i < k) {
    j = Math.floor(Math.random() * s.length);
    a.push(s.splice(j, 1)[0]);
  };
  return a;
}
function unorderedPairs (s) { // returns the list of all unordered pairs from s
  var i = -1, a = [], j;
  while (++i < s.length) {
    j = i;
    while (++j < s.length) a.push([s[i],s[j]])
  };
  return a;
}



  </script>


</body>
</html>
